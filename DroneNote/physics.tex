%TODO simulation parameters
Speak about dt
Speak about step N. When omitted means we take it at step N.

\subsection{Motor Physics}
The model is equipped with brushless motors that can be modelled using a serie
of parameters depending on its eletrical properties and on the propeller
properties. The following equations will only make use of proportionality
constants that are combinations of these parameters. The full derivation can be
found in \app{motorDerivation}.
Each motor is generating two effects: the thrust and the torque, both being directed along the z axis.
	
The motor response is regulated by its rotation speed $\om$. From a hardware
point of view, the control is done by variating the electrical current sent to
the motor but we will assume a proportional relation between them. The
supervision program will simply have to remap the output of the controller to
the current sent to the motor.

The thrust for the motor $i$ is given by
\begin{equation}\labeleq{motorThrust}
	T_i = \left(\frac{K_vK_\tau\sqrt{2\rho A_S}}{K_t}\right)^2\om^2
	= k\om^2
\end{equation}
and the torque is
\begin{equation}\labeleq{motorTau}
	\tau_i = (-1)^{d}\frac{R^3\rho C_D A_X}{2}\om^2 + I_i\omd = (-1)^{d}b_i\om^2
	+ I_i\omd
\end{equation}
where $d=0$ for motors spinning clockwise and $d=1$ for those spinning
counter-clockwise and $I_i$ is the moment of inertia of the motor $i$ around the z
axis. The motor angular acceleration is given by taking the numerical derivative
\begin{equation}
	\omdi{N} = \frac{\omi{N}-\omi{N-1}}{dt}
\end{equation} 
For the signification of all the other parameters, please refer to \app{motorDerivation}.

\subsection{Quadcopter physics}
The total thrust and torque applying on the model is a combination of those
generated by the four motors. The motion of the body is decomposed into a
translational and a rotational component.

\subsubsection{Rotation} 
The rotational movements are due to the combined action of the motors torque and thrust. The total torque around the z
axis is the sum of all motor torques while the total torque along one of the body plane axis is only due to
the sum of the body torque generated by the motor thrust on the perpendicular body plane axis, i.e. the
total torque along the x axis is due to the motors on the y axis and vice-versa. If the motors 1 and 3 are chosen to be
on the y axis and 2 and 4 on the x axis:
\begin{equation}\labeleq{bodyTau}
	\v{\tau} = \matrix{
	L_1T_1-L_3T_3\\
	L_2T_2-L_4T_4\\
	\sum_{i}{\tau_i}
	} = \matrix{
	L_1k_1\omega_1^2 - L_3k_3\omega_3^2\\
	L_2k_2\omega_2^2 - L_4k_4\omega_4^2\\
	\sum_{i}{b_i \omega_i^2}
	}
\end{equation}
Where the $L_i$ are the distances between the center of the body and the motors.
From this point the angular movement can be computed. The angular acceleration is extracted from
\begin{equation}
	\v{\tau} = I\v{\dot{\omega}} + \v{\omega}\times(I\v{\omega})
\end{equation}
Isolating $\dot{\omega}$ in this equation supposes to invert the inertia matrix $I$. The off-diagonal terms will be
neglected as this will greatly simplify the subsequent computation, especially in \sec{Controller}. This will also
greatly reduce the computational cost as the inversion can be done analytically by replacing each diagonal term by its
inverse.
\begin{equation}
	I = \matrix{
	I_{xx} & I_{xy} & I_{xz}\\
	I_{yx} & I_{yy} & I_{yz}\\
	I_{zx} & I_{zy} & I_{zz}\\ 
	} \approx \matrix{
	I_{xx} 	& 0 		& 0\\
	0 		& I_{yy} 	& 0\\
	0 		& 0 		& I_{zz}\\ 	
	}
\end{equation}
\begin{equation}
	I^{-1} \approx \matrix{
	I_{xx}^{-1} & 0 			& 0\\
	0 			& I_{yy}^{-1} 	& 0\\
	0 			& 0 			& I_{zz}^{-1}\\ 		
	}
\end{equation}

The angular aceleration is then
\begin{align}
	\v{\dot{\omega}} &= I^{-1}(\v{\tau} - \v{\omega}\times(I\v{\omega})) \\
	&= \matrix{
		\frac{\tau_x}{I_{xx}} - I_1\omega_y\omega_z\\
		\frac{\tau_y}{I_{yy}} - I_2\omega_x\omega_z\\
		\frac{\tau_z}{I_{yy}} - I_3\omega_x\omega_y
	}
\end{align}
where $I_1 = \frac{I_{yy}-I_{zz}}{I_{xx}}$, $I_2 = \frac{I_{zz}-I_{xx}}{I_{yy}}$, $I_3 = \frac{I_{xx}-I_{yy}}{I_{zz}}$
are the reduced inertia parameters.

The angular velocity is obtained by numerically integrating the angular acceleration
\begin{equation}
	\v{\omega}_N = \v{\omega}_{N-1} + \v{\dot{\omega}}_N dt
\end{equation} 

To continue and compute the attitude (or rotation of the body) the angular velocities have to be expressed in the
inertial frame as the derivative of \v{\theta}.
\begin{equation}
	\v{\dot{\theta}} = \matrix{\dot{\phi}\\\dot{\theta}\\\dot{\psi}} = \matrix{
		1 & s\phi t\theta & c\phi t\theta\\
		0 & c\phi & -s\phi\\ 
		0 & \frac{s\phi}{c\theta} & \frac{c\phi}{c\theta}
	}\matrix{\omega_x\\\omega_y\\\omega_z}
\end{equation}

The rotation angles are given by the integration of their derivative
\begin{equation}
	\v{\theta}_N = \v{\theta}_{N-1} + \v{\dot{\theta}}_N dt
\end{equation}

And finally the attitude quaternion \q{q} is computed from these angles using the rules given in \sec{General}.  

\subsubsection{Translation}
The translation motion is due to the total thrust on the body, given
by the sum of the thrust of all motors. 
\begin{equation}\labeleq{bodyThrust}
	\v{T} = \matrix{0\\0\\\sum_{i}{\v{T_i}}} = \matrix{0\\0\\\sum_{i}{k_i\om^2}}
\end{equation}
The drag force $\v{F}_D$ proportional to the linear speed adds up to the force giving a possible non zero transverse
component.
\begin{equation}
	\v{F}_D = -\matrix{k_D\dot{x}\\k_D\dot{y}\\k_D\dot{z}}
\end{equation}

Before computing the resulting motion, the thrust has to be expressed in the
inertial frame (as this translational force is acting to move the body frame):
\begin{equation}
	\q{T'} = \q{q}\q{T}\q{q^*}
\end{equation}
where \q{q} is the quaternion representing the current rotation of the body
frame and determined earlier with the rotational component.
The linear acceleration is extracted from the equation of motion
\begin{equation}
	\v{\ddot{x}} = -\v{g} + \inv{m}\v{T}' + \inv{m}\v{F}_D
\end{equation}

The linear velocity is given by numerically integrating the linear acceleration 
\begin{equation}
	\v{\dot{x}}_N = \v{\dot{x}}_{N-1} + \v{\ddot{x}}_N dt
\end{equation}
And the position by numerically integrating the linear velocity
\begin{equation}
	\v{x}_N = \v{x}_{N-1} + \v{\dot{x}}_N dt
\end{equation}


